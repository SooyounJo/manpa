.stage {
  position: fixed;
  inset: -2px; /* avoid 1px seams/gaps on mobile GPU rounding */
  z-index: 0;
  background: var(--stageColor, #000); /* configurable stage color */
  /* 배경색 전환 시에도 GPU 플리커 방지를 위해 트랜지션 제거 */
  transition: none;
  pointer-events: none; /* make purely decorative */
  /* rely on inset for sizing; avoids vh rounding issues */
  overflow: hidden;
  /* subtle upscaling for all waves */
  --startScale: 0.98;
  --endScale: 1.02; /* tweak here for stronger or weaker overall size */
  --enterDur: 1100ms; /* smoother entrance */
  --ampX: 8px; /* default float amplitude X */
  --ampY: 5px; /* default float amplitude Y */
}

.stageFadeIn {
  animation: stageFadeIn 900ms ease both;
}

.stage::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: url("/img/full.PNG");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.3;
  pointer-events: none;
  z-index: 1; /* behind waves (waves start ~100+) */
}

.wave {
  position: absolute;
  inset: -2px; /* avoid edge seams */
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  object-fit: cover; /* images are full-frame mobile comps */
  opacity: 0;
  /* default enter offset; overridden per-image via CSS vars */
  --enterX: 0;
  --enterY: 40px;
  --enterBlur: 3px; /* lower blur to reduce perceived flicker */
  transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--startScale));
  filter: blur(var(--enterBlur));
  will-change: transform, opacity;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  transform-style: preserve-3d;
  -webkit-transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--startScale));
  image-rendering: auto;
  /* per-image animation tuning (overridable from inline styles) */
  --floatDur: 6000ms;
  --floatDelay: 0ms;
}

/* Android stability: avoid large blur filters on full-screen PNGs (can create flicker/black tiles) */
body.is-android .wave {
  filter: none !important;
}

/* Story mode: keep non-visible waves hidden; when .visible is applied they translate in (no fade). */
.story .wave {
  opacity: 0;
  filter: none;
}
.story .visible,
.story .reenter,
.story .reenterSoft {
  opacity: 1;
}

.dim {
  position: absolute;
  inset: 0;
  /* 성능/안정성을 위해 단색 인디고 + opacity 애니메이션만 사용 */
  background: rgba(15, 25, 55, 1);
  opacity: var(--dimOpacity, 0);
  transition: opacity 900ms ease;
  pointer-events: none;
  z-index: 3000; /* ensure above all waves */
  will-change: opacity;
  transform: translateZ(0);
}

.visible {
  /* entrance then continuous float */
  animation:
    enter var(--enterDur) cubic-bezier(.18,.90,.24,1) var(--enterDelay, 0ms) forwards,
    floatXY var(--floatDur) ease-in-out calc(var(--enterDur) + var(--enterDelay, 0ms) + var(--floatDelay)) infinite alternate;
}
.story .visible {
  /* In story: slow translate-only entrance, no fade */
  animation:
    enterTranslate var(--storyEnterDur, var(--enterDur)) cubic-bezier(.20,.90,.30,1.02) var(--enterDelay, 0ms) forwards,
    floatXY var(--floatDur) ease-in-out calc(var(--storyEnterDur, var(--enterDur)) + var(--enterDelay, 0ms) + var(--floatDelay)) infinite alternate;
}

.exit {
  animation: exitFade 700ms ease-in forwards;
}

/* Story-only exit: translate out (no opacity change) to avoid "flash" */
.storyExit {
  animation: exitTranslate 900ms cubic-bezier(.20,.90,.30,1.02) forwards;
}
.reenter {
  animation:
    reenter 900ms cubic-bezier(.16,.84,.44,1) forwards,
    floatXY var(--floatDur) ease-in-out 900ms infinite alternate;
}
.reenterSoft {
  /* opacity/blur-only re-entry to avoid spatial jump */
  animation:
    reenterFade 700ms ease-out forwards,
    floatXY var(--floatDur) ease-in-out 700ms infinite alternate;
}
.story .reenterSoft {
  /* in story: also translate-only, no fade */
  animation:
    reenterTranslate var(--reDur, 700ms) cubic-bezier(.16,.84,.44,1) var(--reDelay, 0ms) forwards,
    floatXY var(--floatDur) ease-in-out calc(var(--reDelay, 0ms) + var(--reDur, 700ms)) infinite alternate;
}
.layer1 { z-index: 40; }
.layer2 { z-index: 30; }
.layer3 { z-index: 20; }
.layer4 { z-index: 10; }

@keyframes enter {
  from {
    opacity: 0;
    transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--startScale));
    filter: blur(var(--enterBlur));
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
    filter: blur(0px);
  }
}

@keyframes floatXY {
  /* start exactly where 'enter' ends to avoid any jump */
  0%   { transform: translate3d(0, 0, 0) scale(var(--endScale)); }
  50%  { transform: translate3d(var(--ampX), calc(var(--ampY) * -1), 0) scale(var(--endScale)); }
  100% { transform: translate3d(0, 0, 0) scale(var(--endScale)); }
}

@keyframes exitFade {
  from {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
  }
  to {
    opacity: 0;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
  }
}

@keyframes exitTranslate {
  from {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
  }
  to {
    opacity: 1;
    transform: translate3d(var(--exitX, 0), var(--exitY, 0), 0) scale(var(--endScale));
  }
}

@keyframes reenter {
  from {
    opacity: 0;
    transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--endScale));
    filter: blur(var(--enterBlur));
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
    filter: blur(0px);
  }
}

@keyframes reenterFade {
  from {
    opacity: 0;
    transform: translate3d(0, 0, 0) scale(var(--endScale)); /* no filter to avoid flicker */
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
    /* no filter */
  }
}

@keyframes enterTranslate {
  from {
    opacity: 1;
    transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--startScale));
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
  }
}

@keyframes reenterTranslate {
  from {
    opacity: 1;
    transform: translate3d(var(--enterX), var(--enterY), 0) scale(var(--endScale));
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(var(--endScale));
  }
}

@keyframes stageFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}


